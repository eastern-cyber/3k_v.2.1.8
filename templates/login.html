<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KokKokKok - Login</title>
    <link rel="shortcut icon" type="image/x-icon" href="/static/images/favicon.ico">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <style type="text/tailwindcss">
        [x-cloak] {
            display: none !important; 
        }
        body {
            @apply font-light
        }
        h1 {
            @apply text-[2rem] font-bold
        }
        .input-field {
            @apply bg-neutral-100 w-full px-3 py-2.5 border border-neutral-300 rounded-sm placeholder-neutral-400 focus:border-neutral-400 focus:outline-hidden 
        }
        .button {
            @apply bg-neutral-100 w-full px-3 py-2.5 rounded-sm font-medium text-neutral-400 select-none
        }
        .button-active {
            @apply bg-rose-500 hover:bg-rose-600 text-white cursor-pointer
        }
    </style>
</head>
<body>
    <div class="min-h-[100dvh] grid grid-rows-[auto_1fr_auto]">
        <header class="sticky top-0 z-10">
            <div class="bg-white h-[60px] flex items-center px-2.5">
                <a href="/">
                    <img src="/static/images/3k_v.2.1.5.png" alt="KokKokKok Logo">
                </a>
            </div>
        </header>

        <main>
            <div class="max-w-[360px] mx-auto pt-16">
                <h1 class="text-center pb-4">ล็อกอิน</h1>
                <div class="mb-10">
                    <!-- FIXED FORM WITH PROPER ALPINE.JS -->
                    <div x-data="loginForm()" x-init="init()">
                        <form @submit.prevent="handleSubmit">
                            <p class="font-medium text-sm mb-1">อีเมล</p>
                            <div class="flex flex-col gap-2 mb-2">
                                <!-- Email input -->
                                <input x-model="email" 
                                       type="text" 
                                       placeholder="อีเมล" 
                                       class="input-field" 
                                       :disabled="loading"
                                       required>
                                
                                <!-- Password input with show/hide toggle -->
                                <div class="grid relative w-full">
                                    <input x-model="password" 
                                           :type="passwordVisible ? 'text' : 'password'" 
                                           placeholder="รหัสผ่าน" 
                                           class="input-field" 
                                           :disabled="loading"
                                           required>
                                    <button type="button" 
                                            @click="passwordVisible = !passwordVisible" 
                                            class="h-5 w-5 absolute top-3 right-3.5 fill-neutral-500 cursor-pointer bg-transparent border-0">
                                        <svg x-show="!passwordVisible" class="w-5 h-5" viewBox="0 0 48 48">
                                            <path d="M38.88 41.7a1 1 0 0 0 1.41 0l1.42-1.4a1 1 0 0 0 0-1.42l-3.86-3.86a24.57 24.57 0 0 0 6.27-9.69 1 1 0 0 0 0-.66C41 15.8 32.66 9 23 9c-3.27 0-6.35.73-9.12 2.05L9.12 6.29a1 1 0 0 0-1.41 0L6.29 7.71a1 1 0 0 0 0 1.41l32.59 32.59Zm-22-27.66A17.8 17.8 0 0 1 23 13c12.75 0 17 12 17 12s-1.38 3.9-4.93 7.25l-4.54-4.55A7.99 7.99 0 0 0 23 17c-.95 0-1.86.16-2.7.47l-3.43-3.43ZM1.87 24.67a24.64 24.64 0 0 1 5.8-9.23l2.77 2.78C7.25 21.46 6 25 6 25s4.25 12 17 12a18 18 0 0 0 5.42-.8l3.05 3.05A21.2 21.2 0 0 1 23 41c-9.83 0-17.93-6.63-21.13-15.67a1 1 0 0 1 0-.66Z"></path>
                                            <path d="M15 25c0-.68.08-1.35.24-1.98l9.74 9.73A8.02 8.02 0 0 1 15 25Z"></path>
                                        </svg>
                                        <svg x-show="passwordVisible" x-cloak class="w-5 h-5" viewBox="0 0 48 48" >
                                            <path d="M41.4 23.71a.9.9 0 0 1 0 .58c-.63 1.92-2.2 4.89-4.82 7.51A17.35 17.35 0 0 1 24 37.11c-5.42 0-9.55 2.28-12.58 5.3a20.44 20.44 0 0 1-4.82-7.52.9.9 0 0 1 0-.58c.63-1.92 2.2-4.89 4.82-7.51A17.35 17.35 0 0 1 24 10.89c5.42 0 9.55 2.28 12.58 5.3a20.44 20.44 0 0 1 4.82 7.52ZM24 41c13.83 0 20.82-11.7 21.96-16.81a.85.85 0 0 0 0-.38C44.82 18.71 37.83 7 24 7S3.18 18.7 2.04 23.81a.85.85 0 0 0 0 .38C3.18 29.29 10.17 41 24 41Z"></path>
                                            <path d="M24 27.21a3.21 3.21 0 1 1 0-6.42 3.21 3.21 0 0 1 0 6.42Zm0 4.29a7.5 7.5 0 1 0 0-15 7.5 7.5 0 0 0 0 15Z"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Error message display -->
                            <div x-show="error" x-cloak class="text-red-500 text-sm mb-4">
                                <span x-text="error"></span>
                            </div>
                            
                            <a href="/forgot-password" class="inline-block align-top text-xs font-medium text-neutral-500 hover:underline hover:text-black mb-6">
                                ลืมรหัสผ่าน?
                            </a>
                            
                            <button type="submit" 
                                    class="button flex items-center justify-center gap-2"
                                    :class="{ 'button-active': email && password, 'opacity-70 cursor-not-allowed': loading }"
                                    :disabled="loading || !email || !password">
                                <svg x-show="loading" class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span x-text="loading ? 'Logging in...' : 'ล็อกอิน'"></span>
                            </button>
                        </form>
                    </div>
                </div>
                
                <div class="p-0 flex justify-center font-bold">
                    <p class="p-4 rounded-sm bg-neutral-200 mb-6 hover:bg-red-500">
                        <a href="/templates/home.html" class="font-medium hover:bg-red-500 text-neutral-600 hover:text-neutral-100">
                            ต้นแบบแอ๊พพลิเคชั่น
                        </a>
                    </p>
                </div>
                
                <div class="flex justify-center">
                    <a href="/" class="flex items-center">
                        <div class="w-3.5 h-3.5">
                            <svg viewBox="0 0 48 48">
                                <path d="M4.58579 22.5858L20.8787 6.29289C21.2692 5.90237 21.9024 5.90237 22.2929 6.29289L23.7071 7.70711C24.0976 8.09763 24.0976 8.7308 23.7071 9.12132L8.82843 24L23.7071 38.8787C24.0976 39.2692 24.0976 39.9024 23.7071 40.2929L22.2929 41.7071C21.9024 42.0976 21.2692 42.0976 20.8787 41.7071L4.58579 25.4142C3.80474 24.6332 3.80474 23.3668 4.58579 22.5858Z"></path>
                            </svg>
                        </div>
                        <p class="font-medium">กลับหน้าหลัก</p>
                    </a>
                </div>
            </div>
        </main>

        <footer>
            <div class="text-center p-5 border-t border-neutral-300">
                <p>ยังไม่ได้เป็นสมาชิก? <a href="/templates/signup.html" class="text-rose-500 font-medium hover:underline">ลงทะเบียน</a></p>
            </div>
            <div class="bg-black text-neutral-400 h-21 flex items-center justify-end px-36 text-sm">
                <p>© 2025 KokKokKok</p>
            </div>
        </footer>
    </div>
    
    <script>
    // Define the Alpine.js component
    document.addEventListener('alpine:init', () => {
        Alpine.data('loginForm', () => ({
            email: '',
            password: '',
            passwordVisible: false,
            loading: false,
            error: '',
            
            init() {
                console.log('Login form initialized');
            },
            
            // REPLACED handleSubmit function:
            async handleSubmit() {
                // Prevent empty submission
                if (!this.email || !this.password) {
                    this.error = 'Please enter both email and password';
                    return;
                }
                
                this.loading = true;
                this.error = '';
                
                try {
                    // Always use production URL for now
                    const apiUrl = '/api/auth/login';  // ใช้ relative URL
                    
                    console.log('Attempting login to:', apiUrl);
                    console.log('Credentials:', { email: this.email });
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: this.email,
                            password: this.password
                        }),
                        credentials: 'include' // Important for cookies if needed
                    });
                    
                    console.log('Response status:', response.status);
                    
                    // Get response text first to check if it's JSON
                    const responseText = await response.text();
                    console.log('Raw response:', responseText.substring(0, 200));
                    
                    let data;
                    try {
                        data = JSON.parse(responseText);
                    } catch (e) {
                        console.error('Failed to parse JSON:', e);
                        throw new Error('Server returned invalid JSON: ' + responseText.substring(0, 100));
                    }
                    
                    console.log('Response data:', data);
                    
                    // Inside handleSubmit() function, update the success handler:
                    if (response.ok && data.success) {
                        // Store authentication data with correct keys
                        if (data.token) {
                            localStorage.setItem('token', data.token);
                            localStorage.setItem('user_token', data.token); // For compatibility
                        }
                        if (data.user) {
                            localStorage.setItem('user', JSON.stringify(data.user));
                            localStorage.setItem('user_data', JSON.stringify(data.user)); // For compatibility
                        }
                        
                        // Store backend URL for future API calls
                        localStorage.setItem('backend_url', 'https://3k214.dfi.fund');
                        
                        // Show success message
                        this.error = '✅ Login successful!';
                        
                        // Redirect to dashboard
                        setTimeout(() => {
                            // Use absolute URL to avoid redirect issues
                            window.location.href = 'https://3kv215.dfi.fund/templates/dashboard.html';
                        }, 1000);
                    } else {
                        this.error = data.message || 'Invalid email or password';
                    }
                } catch (error) {
                    console.error('Login error details:', error);
                    
                    // Check error type
                    if (error.message.includes('Failed to fetch') || 
                        error.message.includes('NetworkError') ||
                        error.message.includes('CORS')) {
                        
                        this.error = 'Connection error. Please check your internet connection.';
                        console.log('CORS/Network error. Make sure backend has proper CORS headers.');
                    } else {
                        this.error = 'Error: ' + error.message;
                    }
                } finally {
                    this.loading = false;
                }
            }
        }));
    });
    
    // Alternative simple implementation for testing
    function simpleLogin() {
        const email = document.querySelector('[x-model="email"]')?.value || 
                     document.querySelector('input[name="email"]')?.value;
        const password = document.querySelector('[x-model="password"]')?.value || 
                        document.querySelector('input[name="password"]')?.value;
        
        if (!email || !password) {
            alert('Please enter both email and password');
            return false;
        }
        
        console.log('Login attempt:', { email, password });
        
        // Simple demo login
        localStorage.setItem('demo_user', 'true');
        localStorage.setItem('demo_email', email);
        
        // Show loading
        const btn = document.querySelector('button[type="submit"]');
        const originalText = btn.textContent;
        btn.textContent = 'Logging in...';
        btn.disabled = true;
        
        setTimeout(() => {
            window.location.href = '/templates/home.html';
        }, 1000);
        
        return false; // Prevent form submission
    }
    
    // Add event listener for testing
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                // If Alpine.js fails, use simple login
                if (!window.Alpine) {
                    e.preventDefault();
                    simpleLogin();
                }
            });
        }
        
        // Debug: Check if Alpine.js is loaded
        console.log('Alpine.js loaded:', !!window.Alpine);
        console.log('Current URL:', window.location.href);
    });
    </script>
</body>
</html>